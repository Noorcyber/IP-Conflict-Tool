#!/bin/sh

display_datto_netrunners() {
cat << "EOF"

██╗██████╗ ██████╗ ███████╗ ██████╗ ██████╗ ███╗   ██╗
██║██╔══██╗██╔══██╗██╔════╝██╔════╝██╔═══██╗████╗  ██║
██║██████╔╝██████╔╝█████╗  ██║     ██║   ██║██╔██╗ ██║
██║██╔═══╝ ██╔══██╗██╔══╝  ██║     ██║   ██║██║╚██╗██║
██║██║     ██║  ██║███████╗╚██████╗╚██████╔╝██║ ╚████║
╚═╝╚═╝     ╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚══════╝ ╚═╝  ╚═══╝

  By Noor Shaheed, Datto, Kaseya. 05/27/2024 IP Conflict Tool V.01
EOF
}

display_datto_netrunners

echo "\nFetching ARP table using 'ip neigh'...\n"

arp_output="$(ip neigh 2>/dev/null)"

echo "ARP Table:"
echo "-------------------------------------------------------------"
printf "%-16s %-10s %-20s %-10s\n" "IP Address" "Interface" "MAC Address" "Status"
echo "-------------------------------------------------------------"

echo "$arp_output" | while IFS= read -r line; do
    ip_addr=$(echo "$line" | awk '{print $1}')
    iface=$(echo "$line" | awk '{print $3}')
    mac=$(echo "$line" | awk '{for(i=1;i<=NF;i++) if ($i=="lladdr") print $(i+1)}')
    status=$(echo "$line" | awk '{print $NF}')
    [ -z "$mac" ] && mac="N/A"
    printf "%-16s %-10s %-20s %-10s\n" "$ip_addr" "$iface" "$mac" "$status"
done

echo "\nAnalyzing ARP table for IP conflicts...\n"

echo "$arp_output" | awk '{for(i=1;i<=NF;i++) if ($i=="lladdr") print $(i+1)}' | grep -v "^$" | sort | uniq -d > /tmp/conflicts.txt

if [ ! -s /tmp/conflicts.txt ]; then
    echo "✅ No IP conflicts detected."
else
    echo "⚠️  IP conflicts detected:\n"
    while IFS= read -r mac; do
        echo "MAC Address: $mac"
        echo "------------------------"
        echo "$arp_output" | grep "$mac" | while IFS= read -r entry; do
            ip_addr=$(echo "$entry" | awk '{print $1}')
            iface=$(echo "$entry" | awk '{print $3}')
            status=$(echo "$entry" | awk '{print $NF}')
            printf "  %-16s %-10s %-10s\n" "$ip_addr" "$iface" "$status"
        done
        echo
    done < /tmp/conflicts.txt
fi
